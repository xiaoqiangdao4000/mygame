{"version":3,"sources":["file:///C:/Users/zzx/Desktop/mygame/assets/scripts/OpenContext.ts"],"names":["_decorator","Component","WECHAT","tools","ccclass","property","OpenContext","start","onEnable","setUserLevel","console","log","openContext","wx","getOpenDataContext","testLevel","getLevel","window","setUserCloudStorage","KVDataList","key","value","String","success","res","postMessage","type","event","fail","onBtnClick","data","node","active","update","deltaTime","_reportUserLevel","level","listener","target","apply","err"],"mappings":";;;;;;;;;;;;;;;;AAASA,MAAAA,U,OAAAA,U;AAAYC,MAAAA,S,OAAAA,S;;AACZC,MAAAA,M,UAAAA,M;;AACFC,MAAAA,K;;;;;;;;;OACD;AAAEC,QAAAA,OAAF;AAAWC,QAAAA;AAAX,O,GAAwBL,U;;6BAGjBM,W,WADZF,OAAO,CAAC,aAAD,C,gBAAR,MACaE,WADb,SACiCL,SADjC,CAC2C;AAEvC;AAEAM,QAAAA,KAAK,GAAG,CACJ;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACH;;AAESC,QAAAA,QAAQ,GAAS;AACvB,eAAKC,YAAL;AACAC,UAAAA,OAAO,CAACC,GAAR,CAAY,gBAAZ;AACH;;AAEDF,QAAAA,YAAY,GAAG;AACX,cAAIP,MAAJ,EAAY;AACR;AACA,gBAAIU,WAAW,GAAGC,EAAE,CAACC,kBAAH,EAAlB,CAFQ,CAEmC;;AAC3C,gBAAIC,SAAS,GAAG;AAAA;AAAA,gCAAMC,QAAN,EAAhB,CAHQ,CAG0B;AAClC;;AAEAC,YAAAA,MAAM,CAAC,IAAD,CAAN,CAAaC,mBAAb,CAAiC;AAC7BC,cAAAA,UAAU,EAAE,CAAC;AAAEC,gBAAAA,GAAG,EAAE,OAAP;AAAgBC,gBAAAA,KAAK,EAAEC,MAAM,CAACP,SAAD;AAA7B,eAAD,CADiB;AAE7BQ,cAAAA,OAAO,EAAEC,GAAG,IAAI;AACZd,gBAAAA,OAAO,CAACC,GAAR,CAAY,SAAZ;AACAD,gBAAAA,OAAO,CAACC,GAAR,CAAYa,GAAZ,EAFY,CAGZ;;AAEAP,gBAAAA,MAAM,CAAC,IAAD,CAAN,CAAaQ,WAAb,CAAyB;AAAEC,kBAAAA,IAAI,EAAE,QAAR;AAAkBC,kBAAAA,KAAK,EAAE;AAAzB,iBAAzB,EALY,CAMZ;AACA;AACA;AACH,eAX4B;AAY7BC,cAAAA,IAAI,EAAEJ,GAAG,IAAI;AACTd,gBAAAA,OAAO,CAACC,GAAR,CAAY,SAAZ;AACAD,gBAAAA,OAAO,CAACC,GAAR,CAAYa,GAAZ;AACH;AAf4B,aAAjC;AAiBH;AACJ,SApDsC,CAsDvC;;;AACAK,QAAAA,UAAU,CAACF,KAAD,EAAQG,IAAR,EAAc;AACpB,cAAIA,IAAI,IAAI,OAAZ,EAAqB;AACjB,iBAAKC,IAAL,CAAUC,MAAV,GAAmB,KAAnB,CADiB,CAEjB;AACH,WAJmB,CAKpB;AACA;AACA;;AACH;;AAEDC,QAAAA,MAAM,CAACC,SAAD,EAAoB,CAEzB;;AAEOC,QAAAA,gBAAgB,CAACC,KAAD,EAAgBC,QAAhB,EAAqCC,MAArC,EAAmD;AACvE,cAAI,CAACpC,MAAL,EAAa;AACT;AACH,WAHsE,CAKvE;;;AACAW,UAAAA,EAAE,CAACK,mBAAH,CAAuB;AAAE;AACrBC,YAAAA,UAAU,EAAE,CACR;AAAEC,cAAAA,GAAG,EAAE,OAAP;AAAgBC,cAAAA,KAAK,EAAG,GAAEe,KAAM;AAAhC,aADQ,CADO;AAKnBb,YAAAA,OAAO,EAAE,MAAM;AACXc,cAAAA,QAAQ,QAAR,IAAAA,QAAQ,CAAEE,KAAV,CAAgBD,MAAhB;AACH,aAPkB;AASnBV,YAAAA,IAAI,EAAGY,GAAD,IAAc;AAChB9B,cAAAA,OAAO,CAACC,GAAR,CAAY,qBAAZ,EAAmC6B,GAAnC;AACH;AAXkB,WAAvB;AAaH;;AAxFsC,O","sourcesContent":["import { _decorator, Component, Node, sys } from 'cc';\r\nimport { WECHAT } from 'cc/env';\r\nimport tools from './tools';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('OpenContext')\r\nexport class OpenContext extends Component {\r\n\r\n    // private _openContext: any; // 子域对象\r\n\r\n    start() {\r\n        // if (WECHAT) {\r\n        //     // @ts-ignore\r\n        //     this._openContext = wx.getOpenDataContext();\r\n        // }\r\n\r\n        // if (WECHAT) { //判断微信环境\r\n        //     // @ts-ignore\r\n        //     this._openContext = wx.getOpenDataContext(); // 调用微信接口获取子域句柄，使用时需要检查\r\n\r\n        //     let testLevel = 5; // 测试数据\r\n\r\n        //     this._reportUserLevel(testLevel, () => {\r\n        //         this._openContext.postMessage({ type: 'engine', event: 'level' }); // level为自定义key，如果没有特殊需求，建议直接用。否则你的变动比较大，调整wx-sub-project/index.js的对应的key和this._reportUserLevel的key都需要对齐\r\n        //     });\r\n        // }\r\n    }\r\n\r\n    protected onEnable(): void {\r\n        this.setUserLevel();\r\n        console.log('上报请求排行榜数据.....');\r\n    }\r\n\r\n    setUserLevel() {\r\n        if (WECHAT) {\r\n            // @ts-ignore\r\n            var openContext = wx.getOpenDataContext(); // 调用微信接口获取子域句柄，使用时需要检查\r\n            let testLevel = tools.getLevel(); // 测试数据\r\n            //  this._openContext.postMessage({ type: 'engine', event: 'level' });\r\n\r\n            window['wx'].setUserCloudStorage({\r\n                KVDataList: [{ key: 'level', value: String(testLevel) }],\r\n                success: res => {\r\n                    console.log('上报数据成功：');\r\n                    console.log(res);\r\n                    // 让子域更新当前用户的最高分，因为主域无法得到getUserCloadStorage;\r\n\r\n                    window['wx'].postMessage({ type: 'engine', event: 'level' });\r\n                    // openDataContext.postMessage({\r\n                    //     type: 'updateMaxScore',\r\n                    // });\r\n                },\r\n                fail: res => {\r\n                    console.log('上报数据失败：');\r\n                    console.log(res);\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    //开始按钮\r\n    onBtnClick(event, data) {\r\n        if (data == \"close\") {\r\n            this.node.active = false;\r\n            //this.setUserLevel();\r\n        }\r\n        // else if (data == 'rankBtn') {\r\n        //     this.setUserLevel();\r\n        // }\r\n    }\r\n\r\n    update(deltaTime: number) {\r\n\r\n    }\r\n\r\n    private _reportUserLevel(level: number, listener?: Function, target?: any) {\r\n        if (!WECHAT) {\r\n            return;\r\n        }\r\n\r\n        // @ts-ignore\r\n        wx.setUserCloudStorage({ //调用微信接口上报关卡等级信息，用于好友圈排行\r\n            KVDataList: [\r\n                { key: 'level', value: `${level}` }\r\n            ],\r\n\r\n            success: () => {\r\n                listener?.apply(target);\r\n            },\r\n\r\n            fail: (err: any) => {\r\n                console.log('report level error:', err);\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\n\r\n"]}